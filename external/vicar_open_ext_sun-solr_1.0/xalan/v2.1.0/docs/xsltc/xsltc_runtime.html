<HTML><HEAD><SCRIPT language="JavaScript" src="resources/script.js" type="text/javascript"></SCRIPT><TITLE>XSLTC runtime environment</TITLE></HEAD><BODY alink="#ff0000" bgcolor="#ffffff" leftmargin="4" link="#0000ff" marginheight="4" marginwidth="4" text="#000000" topmargin="4" vlink="#0000aa"><TABLE border="0" cellpadding="0" cellspacing="0" width="620"><TR><TD align="left" height="60" rowspan="3" valign="top" width="135"><IMG border="0" height="60" hspace="0" src="resources/logo.gif" vspace="0" width="135"></TD><TD align="left" colspan="4" height="5" valign="top" width="456"><IMG border="0" height="5" hspace="0" src="resources/line.gif" vspace="0" width="456"></TD><TD align="left" height="60" rowspan="3" valign="top" width="29"><IMG border="0" height="60" hspace="0" src="resources/right.gif" vspace="0" width="29"></TD></TR><TR><TD align="left" bgcolor="#0086b2" colspan="4" height="35" valign="top" width="456"><IMG alt="" border="0" height="35" hspace="0" src="graphics/xsltc_runtime-header.jpg" vspace="0" width="456"></TD></TR><TR><TD align="left" height="20" valign="top" width="168"><IMG border="0" height="20" hspace="0" src="resources/bottom.gif" vspace="0" width="168"></TD><TD align="left" height="20" valign="top" width="96"><A href="http://xml.apache.org/" onMouseOut="rolloverOff('xml');" onMouseOver="rolloverOn('xml');" target="new"><IMG alt="http://xml.apache.org/" border="0" height="20" hspace="0" name="xml" onLoad="rolloverLoad('xml','resources/button-xml-hi.gif','resources/button-xml-lo.gif');" src="resources/button-xml-lo.gif" vspace="0" width="96"></A></TD><TD align="left" height="20" valign="top" width="96"><A href="http://www.apache.org/" onMouseOut="rolloverOff('asf');" onMouseOver="rolloverOn('asf');" target="new"><IMG alt="http://www.apache.org/" border="0" height="20" hspace="0" name="asf" onLoad="rolloverLoad('asf','resources/button-asf-hi.gif','resources/button-asf-lo.gif');" src="resources/button-asf-lo.gif" vspace="0" width="96"></A></TD><TD align="left" height="20" valign="top" width="96"><A href="http://www.w3.org/" onMouseOut="rolloverOff('w3c');" onMouseOver="rolloverOn('w3c');" target="new"><IMG alt="http://www.w3.org/" border="0" height="20" hspace="0" name="w3c" onLoad="rolloverLoad('w3c','resources/button-w3c-hi.gif','resources/button-w3c-lo.gif');" src="resources/button-w3c-lo.gif" vspace="0" width="96"></A></TD></TR></TABLE><TABLE border="0" cellpadding="0" cellspacing="0" width="620"><TR><TD align="left" valign="top" width="120"><IMG border="0" height="14" hspace="0" src="resources/join.gif" vspace="0" width="120"><BR>
 
  <A href="index.html" onMouseOut="rolloverOff('side-index');" onMouseOver="rolloverOn('side-index');"><IMG alt="Overview" border="0" height="12" hspace="0" name="side-index" onLoad="rolloverLoad('side-index','graphics/index-label-2.jpg','graphics/index-label-3.jpg');" src="graphics/index-label-3.jpg" vspace="0" width="120"></A><BR>

 <IMG border="0" height="6" hspace="0" src="resources/separator.gif" vspace="0" width="120"><BR>

  <A href="xsltc_compiler.html" onMouseOut="rolloverOff('side-xsltc_compiler');" onMouseOver="rolloverOn('side-xsltc_compiler');"><IMG alt="Compiler design" border="0" height="12" hspace="0" name="side-xsltc_compiler" onLoad="rolloverLoad('side-xsltc_compiler','graphics/xsltc_compiler-label-2.jpg','graphics/xsltc_compiler-label-3.jpg');" src="graphics/xsltc_compiler-label-3.jpg" vspace="0" width="120"></A><BR>

 <IMG border="0" height="6" hspace="0" src="resources/separator.gif" vspace="0" width="120"><BR>
 
   <A href="xsl_whitespace_design.html" onMouseOut="rolloverOff('side-xsl_whitespace_design');" onMouseOver="rolloverOn('side-xsl_whitespace_design');"><IMG alt="Whitespace" border="0" height="12" hspace="0" name="side-xsl_whitespace_design" onLoad="rolloverLoad('side-xsl_whitespace_design','graphics/xsl_whitespace_design-label-2.jpg','graphics/xsl_whitespace_design-label-3.jpg');" src="graphics/xsl_whitespace_design-label-3.jpg" vspace="0" width="120"></A><BR>

  <A href="xsl_sort_design.html" onMouseOut="rolloverOff('side-xsl_sort_design');" onMouseOver="rolloverOn('side-xsl_sort_design');"><IMG alt="xsl:sort" border="0" height="12" hspace="0" name="side-xsl_sort_design" onLoad="rolloverLoad('side-xsl_sort_design','graphics/xsl_sort_design-label-2.jpg','graphics/xsl_sort_design-label-3.jpg');" src="graphics/xsl_sort_design-label-3.jpg" vspace="0" width="120"></A><BR> 

  <A href="xsl_key_design.html" onMouseOut="rolloverOff('side-xsl_key_design');" onMouseOver="rolloverOn('side-xsl_key_design');"><IMG alt="Keys" border="0" height="12" hspace="0" name="side-xsl_key_design" onLoad="rolloverLoad('side-xsl_key_design','graphics/xsl_key_design-label-2.jpg','graphics/xsl_key_design-label-3.jpg');" src="graphics/xsl_key_design-label-3.jpg" vspace="0" width="120"></A><BR> 

  <A href="xsl_comment_design.html" onMouseOut="rolloverOff('side-xsl_comment_design');" onMouseOver="rolloverOn('side-xsl_comment_design');"><IMG alt="Comment design" border="0" height="12" hspace="0" name="side-xsl_comment_design" onLoad="rolloverLoad('side-xsl_comment_design','graphics/xsl_comment_design-label-2.jpg','graphics/xsl_comment_design-label-3.jpg');" src="graphics/xsl_comment_design-label-3.jpg" vspace="0" width="120"></A><BR>
 
  <IMG border="0" height="6" hspace="0" src="resources/separator.gif" vspace="0" width="120"><BR>

  <A href="xsl_lang_design.html" onMouseOut="rolloverOff('side-xsl_lang_design');" onMouseOver="rolloverOn('side-xsl_lang_design');"><IMG alt="lang()" border="0" height="12" hspace="0" name="side-xsl_lang_design" onLoad="rolloverLoad('side-xsl_lang_design','graphics/xsl_lang_design-label-2.jpg','graphics/xsl_lang_design-label-3.jpg');" src="graphics/xsl_lang_design-label-3.jpg" vspace="0" width="120"></A><BR> 

  <A href="xsl_unparsed_design.html" onMouseOut="rolloverOff('side-xsl_unparsed_design');" onMouseOver="rolloverOn('side-xsl_unparsed_design');"><IMG alt="Unparsed entities" border="0" height="12" hspace="0" name="side-xsl_unparsed_design" onLoad="rolloverLoad('side-xsl_unparsed_design','graphics/xsl_unparsed_design-label-2.jpg','graphics/xsl_unparsed_design-label-3.jpg');" src="graphics/xsl_unparsed_design-label-3.jpg" vspace="0" width="120"></A><BR> 
  
 <IMG border="0" height="6" hspace="0" src="resources/separator.gif" vspace="0" width="120"><BR>
   
  <IMG alt="Runtime" border="0" height="12" hspace="0" src="graphics/xsltc_runtime-label-1.jpg" vspace="0" width="120"><BR> 
            
 <IMG border="0" height="6" hspace="0" src="resources/separator.gif" vspace="0" width="120"><BR>

  <A href="xsltc_dom.html" onMouseOut="rolloverOff('side-xsltc_dom');" onMouseOver="rolloverOn('side-xsltc_dom');"><IMG alt="Internal DOM" border="0" height="12" hspace="0" name="side-xsltc_dom" onLoad="rolloverLoad('side-xsltc_dom','graphics/xsltc_dom-label-2.jpg','graphics/xsltc_dom-label-3.jpg');" src="graphics/xsltc_dom-label-3.jpg" vspace="0" width="120"></A><BR>            
            
  <A href="xsltc_namespace.html" onMouseOut="rolloverOff('side-xsltc_namespace');" onMouseOver="rolloverOn('side-xsltc_namespace');"><IMG alt="Namespaces" border="0" height="12" hspace="0" name="side-xsltc_namespace" onLoad="rolloverLoad('side-xsltc_namespace','graphics/xsltc_namespace-label-2.jpg','graphics/xsltc_namespace-label-3.jpg');" src="graphics/xsltc_namespace-label-3.jpg" vspace="0" width="120"></A><BR>             
            
 <IMG border="0" height="6" hspace="0" src="resources/separator.gif" vspace="0" width="120"><BR>
 
   <A href="xsltc_trax.html" onMouseOut="rolloverOff('side-xsltc_trax');" onMouseOver="rolloverOn('side-xsltc_trax');"><IMG alt="Translet & TrAX" border="0" height="12" hspace="0" name="side-xsltc_trax" onLoad="rolloverLoad('side-xsltc_trax','graphics/xsltc_trax-label-2.jpg','graphics/xsltc_trax-label-3.jpg');" src="graphics/xsltc_trax-label-3.jpg" vspace="0" width="120"></A><BR>
 <IMG border="0" height="6" hspace="0" src="resources/separator.gif" vspace="0" width="120"><BR>
 <A href="todo.html" onMouseOut="rolloverOff('side-ext-40');" onMouseOver="rolloverOn('side-ext-40');"><IMG alt="To-do list" border="0" height="12" hspace="0" name="side-ext-40" onLoad="rolloverLoad('side-ext-40','graphics/ext-40-label-2.jpg','graphics/ext-40-label-3.jpg');" src="graphics/ext-40-label-3.jpg" vspace="0" width="120"></A><BR>
            
<IMG border="0" height="14" hspace="0" src="resources/close.gif" vspace="0" width="120"><BR></TD><TD align="left" valign="top" width="500"><TABLE border="0" cellpadding="3" cellspacing="0"><TR><TD>
  <UL>
    <LI><A href="#overview">Runtime overview</A></LI>
    <LI><A href="#translet">The compiled translet</A></LI>
    <LI><A href="#types">External/internal type mapping</A></LI>    
    <LI><A href="#mainloop">Main program loop</A></LI>

  </UL>
  <A name="overview"><!--anchor--></A>
  <TABLE border="0" cellpadding="0" cellspacing="0" width="494"><TR><TD bgcolor="666699" colspan="2" width="494"><TABLE border="0" cellpadding="0" cellspacing="0" width="494"><TR><TD bgcolor="#039acc" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#039acc" height="1" width="492"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="492"></TD><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#039acc" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#0086b2" width="492"><FONT color="#ffffff" face="arial,helvetica,sanserif" size="+1"><IMG border="0" height="2" hspace="0" src="resources/void.gif" vspace="0" width="2"><B>Runtime overview</B></FONT></TD><TD bgcolor="#017299" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#017299" height="1" width="492"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="492"></TD><TD bgcolor="#017299" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR></TABLE></TD></TR><TR><TD width="10">&nbsp;</TD><TD width="484"><FONT color="#000000" face="arial,helvetica,sanserif">
    <P>The actual transformation of the input XML document is initiated by
    one of these classes:</P>

    <UL>
      <LI>
        <CODE><FONT face="courier, monospaced">com.sun.xslt.runtime.DefaultRun</FONT></CODE> (runs in a terminal)
      </LI>
      <LI>
        <CODE><FONT face="courier, monospaced">com.sun.xslt.demo.applet.TransformApplet</FONT></CODE> (runs in an applet)
      </LI>
      <LI>
        <CODE><FONT face="courier, monospaced">com.sun.xslt.demo.servlet.Translate</FONT></CODE> (runs in a servlet)
      </LI>
    </UL>

    <P>Any one of these classes will have to go through the folloing steps in
    order to initiate a transformation:</P>

    <UL>
      <LI>
        Instanciate the translet object. The name of the translet (ie. class)
        to use is passed to us as a string. We use this string as a parameter
        to the static method <CODE><FONT face="courier, monospaced">Class.forName(String name)</FONT></CODE> to get a
        reference to a translet object.
      </LI>
      <LI>
        Instanciate a <CODE><FONT face="courier, monospaced">com.sun.xsl.parser.Parser</FONT></CODE> object to parse the
        input XML file, and instanciate a DOM (we have our own DOM
        implementation especially designed for XSLTC) where we store the
        input document.
      </LI>
      <LI>
        Pass any parameters to the translet (currently only possible when
        running the transformation in a terminal using DefaultRun)
      </LI>
      <LI>
        Instanciate a handler for the result document. This handler must be
        extend the <CODE><FONT face="courier, monospaced">TransletOutputHandler</FONT></CODE> class.
      </LI>
      <LI>
        Invoke the <CODE><FONT face="courier, monospaced">transform()</FONT></CODE> method on the translet, passing the
        instanciated DOM and the output handler as parameters.
      </LI>
    </UL>

    </FONT></TD></TR></TABLE><BR><A name="translet"><!--anchor--></A>
    <TABLE border="0" cellpadding="0" cellspacing="0" width="494"><TR><TD bgcolor="666699" colspan="2" width="494"><TABLE border="0" cellpadding="0" cellspacing="0" width="494"><TR><TD bgcolor="#039acc" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#039acc" height="1" width="492"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="492"></TD><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#039acc" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#0086b2" width="492"><FONT color="#ffffff" face="arial,helvetica,sanserif" size="+1"><IMG border="0" height="2" hspace="0" src="resources/void.gif" vspace="0" width="2"><B>The compiled translet</B></FONT></TD><TD bgcolor="#017299" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#017299" height="1" width="492"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="492"></TD><TD bgcolor="#017299" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR></TABLE></TD></TR><TR><TD width="10">&nbsp;</TD><TD width="484"><FONT color="#000000" face="arial,helvetica,sanserif">

    <P>A translet is always a subclass of <CODE><FONT face="courier, monospaced">AbstractTranslet</FONT></CODE>. As well
    as having access to the public/protected methods in this class, the
    translet is compiled with these methods:</P>

    <P><CODE><FONT face="courier, monospaced">public void transform(DOM, NodeIterator, TransletOutputHandler);</FONT></CODE></P>

    <P>This method is passed a <CODE><FONT face="courier, monospaced">DOMImpl</FONT></CODE> object. Depending on whether
    the stylesheet had any calls to the <CODE><FONT face="courier, monospaced">document()</FONT></CODE> function this
    method will either generate a <CODE><FONT face="courier, monospaced">DOMAdapter</FONT></CODE> object (when only one
    XML document is used as input) or a <CODE><FONT face="courier, monospaced">MultiDOM</FONT></CODE> object (when there
    are more than one XML input documents). This DOM object is passed on to
    the <CODE><FONT face="courier, monospaced">topLevel()</FONT></CODE> method.</P>

    <P>When the <CODE><FONT face="courier, monospaced">topLevel()</FONT></CODE> method returns we initiate the output
    document by calling <CODE><FONT face="courier, monospaced">startDocument()</FONT></CODE> on the supplied output
    handler object. We then call <CODE><FONT face="courier, monospaced">applyTemplates()</FONT></CODE> to get the actual
    output contents, before we close the output document by calling
    <CODE><FONT face="courier, monospaced">endDocument()</FONT></CODE> on the output handler.</P>

    <P><CODE><FONT face="courier, monospaced">public void topLevel(DOM, NodeIterator, TransletOutputHandler);</FONT></CODE></P>

    <P>This method handles all of these top-level elements:</P>
    <UL>
      <LI><CODE><FONT face="courier, monospaced">&lt;xsl:output&gt;</FONT></CODE></LI>
      <LI><CODE><FONT face="courier, monospaced">&lt;xsl:decimal-format&gt;</FONT></CODE></LI>
      <LI><CODE><FONT face="courier, monospaced">&lt;xsl:key&gt;</FONT></CODE></LI>
      <LI><CODE><FONT face="courier, monospaced">&lt;xsl:param&gt;</FONT></CODE> (for global parameters)</LI>
      <LI><CODE><FONT face="courier, monospaced">&lt;xsl:variable&gt;</FONT></CODE> (for global variables)</LI>
    </UL>

    <P><CODE><FONT face="courier, monospaced">public void applyTemplates(DOM, NodeIterator, TransletOutputHandler);</FONT></CODE></P>

    <P>This is the method that produces the actual output. Its central element
    is a big <CODE><FONT face="courier, monospaced">switch()</FONT></CODE> statement that is used to choose the available
    templates for the various node in the input document. See the chapter
    <A href="#mainloop">Main Program Loop</A> for details on this method.</P>

    <P><CODE><FONT face="courier, monospaced">public void &lt;init&gt; ();</FONT></CODE></P>
    <A name="namesarray"><!--anchor--></A>
    <P>The translet's constructor initializes a table
    of all the elements we want to search for in the XML input document.
    This table is called the <CODE><FONT face="courier, monospaced">namesArray</FONT></CODE> and it is passed to the DOM
    holding the input XML document.</P>

    <P>The constructor also initializes any <CODE><FONT face="courier, monospaced">DecimalFormatSymbol</FONT></CODE>
    objects that are used to format numbers before passing them to the
    output handler.</P>

    <P><CODE><FONT face="courier, monospaced">public boolean stripSpace(int nodeType);</FONT></CODE></P>

    <P>This method is only present if any <CODE><FONT face="courier, monospaced">&lt;xsl:strip-space&gt;</FONT></CODE> or
    <CODE><FONT face="courier, monospaced">&lt;xsl:preserve-space&gt;</FONT></CODE> elements are present in the stylesheet.
    If that is the case, the translet implements the
    <CODE><FONT face="courier, monospaced">StripWhitespaceFilter</FONT></CODE> interface by containing this method.</P>

    </FONT></TD></TR></TABLE><BR><A name="types"><!--anchor--></A>
    <TABLE border="0" cellpadding="0" cellspacing="0" width="494"><TR><TD bgcolor="666699" colspan="2" width="494"><TABLE border="0" cellpadding="0" cellspacing="0" width="494"><TR><TD bgcolor="#039acc" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#039acc" height="1" width="492"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="492"></TD><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#039acc" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#0086b2" width="492"><FONT color="#ffffff" face="arial,helvetica,sanserif" size="+1"><IMG border="0" height="2" hspace="0" src="resources/void.gif" vspace="0" width="2"><B>External/internal type mapping</B></FONT></TD><TD bgcolor="#017299" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#017299" height="1" width="492"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="492"></TD><TD bgcolor="#017299" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR></TABLE></TD></TR><TR><TD width="10">&nbsp;</TD><TD width="484"><FONT color="#000000" face="arial,helvetica,sanserif">

    <A name="external-types"><!--anchor--></A>

    <P>This is the very core of XSL transformations: <B>Read carefully!!!</B></P>

    <P>Every node in the input XML document(s) is assigned a type by the
    DOM builder class. This type is an integer value which represents the
    element, so that for instance all <CODE><FONT face="courier, monospaced">&lt;bob&gt;</FONT></CODE> elements in the
    input document will be given type <I>7</I> and can be referred to by using
    that integer. These types can be used for lookups in the
    <A href="#namesarray">namesArray</A> table to get the actual
    element name (in this case &quot;bob&quot;). These types are referred to as
    <B>external types</B> or <B>DOM types</B>, as they are types known only
    to the DOM and the DOM builder.</P>

    <A name="internal-types"><!--anchor--></A>

    <P>Similarly the translet assignes types to all element and attribute names
    that are referenced in the stylesheet. These types are referred to as
    <B>internal types</B> or <B>translet types</B>.</P>

    <P>It is not very probable that there will be a one-to-one mapping between
    internal and external types. There will most often be elements in the DOM
    (ie. the input document) that are not mentioned in the stylesheet, and
    there could be elements in the stylesheet that do not match any elements
    in the DOM. Here is an example:</P>

<DIV align="right"><TABLE border="0" cellpadding="0" cellspacing="4" width="464"><TR><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#0086b2" height="1" width="462"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="462"></TD><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#0086b2" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#ffffff" width="462"><FONT size="-1"><PRE>
      &lt;?xml version=&quot;1.0&quot;?&gt;
      &lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;blahblahblah&quot;&gt;

      &lt;xsl:template match=&quot;/&quot;&gt;
        &lt;xsl:for-each select=&quot;//B&quot;&gt;
          &lt;xsl:apply-templates select=&quot;.&quot; /&gt;
        &lt;/xsl:for-each&gt;
        &lt;xsl:for-each select=&quot;C&quot;&gt;
          &lt;xsl:apply-templates select=&quot;.&quot; /&gt;
        &lt;/xsl:for-each&gt;
        &lt;xsl:for-each select=&quot;A/B&quot;&gt;
          &lt;xsl:apply-templates select=&quot;.&quot; /&gt;
        &lt;/xsl:for-each&gt;
      &lt;/xsl:template&gt;

    &lt;/xsl:stylesheet&gt;
</PRE></FONT></TD><TD bgcolor="#0086b2" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#0086b2" height="1" width="462"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="462"></TD><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR></TABLE></DIV>

    <P>In this stylesheet we are looking for elements <CODE><FONT face="courier, monospaced">&lt;B&gt;</FONT></CODE>,
    <CODE><FONT face="courier, monospaced">&lt;C&gt;</FONT></CODE> and <CODE><FONT face="courier, monospaced">&lt;A&gt;</FONT></CODE>. For this example we can assume
    that these element types will be assigned the values 0, 1 and 2. Now, lets
    say we are transforming this XML document:</P>

<DIV align="right"><TABLE border="0" cellpadding="0" cellspacing="4" width="464"><TR><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#0086b2" height="1" width="462"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="462"></TD><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#0086b2" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#ffffff" width="462"><FONT size="-1"><PRE>
      &lt;?xml version=&quot;1.0&quot;?&gt;

      &lt;A&gt;
        The crocodile cried:
        &lt;F&gt;foo&lt;/F&gt;
        &lt;B&gt;bar&lt;/B&gt;
        &lt;B&gt;baz&lt;/B&gt;
      &lt;/A&gt;
</PRE></FONT></TD><TD bgcolor="#0086b2" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#0086b2" height="1" width="462"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="462"></TD><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR></TABLE></DIV>

    <P>This XML document has the elements <CODE><FONT face="courier, monospaced">&lt;A&gt;</FONT></CODE>,
    <CODE><FONT face="courier, monospaced">&lt;B&gt;</FONT></CODE> and <CODE><FONT face="courier, monospaced">&lt;F&gt;</FONT></CODE>, which we assume are assigned the
    types 7, 8 and 9 respectively  (the numbers below that are assigned for
    specific element types, such as the root node, text nodes, etc.). This
    causes a mismatch between the type used for <CODE><FONT face="courier, monospaced">&lt;B&gt;</FONT></CODE> in the
    translet and the type used for <CODE><FONT face="courier, monospaced">&lt;B&gt;</FONT></CODE> in the DOM. Th
    DOMAdapter class (which mediates between the DOM and the translet) has been
    given two tables for convertint between the two types; <CODE><FONT face="courier, monospaced">mapping</FONT></CODE> for
    mapping from internal to external types, and <CODE><FONT face="courier, monospaced">reverseMapping</FONT></CODE> for
    the other way around.</P>

    <P>The translet contains a <CODE><FONT face="courier, monospaced">String[]</FONT></CODE> array called
    <CODE><FONT face="courier, monospaced">namesArray</FONT></CODE>. This array will contain all the element and attribute
    names that were referenced in the stylesheet. In our example, this array
    would contain these string (in this specific order): &quot;B&quot;, 
    &quot;C&quot; and &quot;A&quot;. This array is passed as one of the
    parameters to the DOM adapter constructor (the other adapter is the DOM
    itself). The DOM adapter passes this table on to the DOM. The DOM has
    a hashtable that maps known element names to external types. The DOM goes
    through the <CODE><FONT face="courier, monospaced">namesArray</FONT></CODE> from the DOM sequentially, looks up each
    name in the hashtable, and is then able to map the internal type to an
    external type. The result is then passed back to the DOM adapter.</P>

    <P>The reverse is done for external types. External types that are not
    interesting for the translet (such as the type for <CODE><FONT face="courier, monospaced">&lt;F&gt;</FONT></CODE>
    elements in the example above) are mapped to a generic <CODE><FONT face="courier, monospaced">&quot;ELEMENT&quot;</FONT></CODE>
    type 3, and are more or less ignored by the translet.</P>

    <P>It is important that we separate the DOM from the translet. In several
    cases we want the DOM as a structure completely independent from the
    translet - even though the DOM is a structure internal to XSLTC. One such
    case is when transformations are offered by a servlet as a web service.
    Any DOM that is built should potentially be stored in a cache and made
    available for simultaneous access by several translet/servlet couples.</P>

    <P><IMG align="right" border="0" hspace="4" src="images/runtime_type_mapping.gif" vspace="4"><BR clear="all"></P>
    <P><I>Figure 1: Two translets accessing a single dom using different type mappings</I></P>

    </FONT></TD></TR></TABLE><BR><A name="mainloop"><!--anchor--></A>
    <TABLE border="0" cellpadding="0" cellspacing="0" width="494"><TR><TD bgcolor="666699" colspan="2" width="494"><TABLE border="0" cellpadding="0" cellspacing="0" width="494"><TR><TD bgcolor="#039acc" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#039acc" height="1" width="492"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="492"></TD><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#039acc" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#0086b2" width="492"><FONT color="#ffffff" face="arial,helvetica,sanserif" size="+1"><IMG border="0" height="2" hspace="0" src="resources/void.gif" vspace="0" width="2"><B>Main program loop</B></FONT></TD><TD bgcolor="#017299" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#017299" height="1" width="492"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="492"></TD><TD bgcolor="#017299" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR></TABLE></TD></TR><TR><TD width="10">&nbsp;</TD><TD width="484"><FONT color="#000000" face="arial,helvetica,sanserif">

    <P>The main loop in the translet is found in the <CODE><FONT face="courier, monospaced">applyTemplates()</FONT></CODE>
    method. This method goes through these steps:</P>

    <UL>
      <LI>
        Get the next node from the node iterator
      </LI>
      <LI>
        Get the internal type of this node. The DOMAdapter object holds the
        internal/external type mapping table, and it will supply the translet
        with the internal type of the current node.
      </LI>
      <LI>
        Execute a switch statement on the internal node type. There will be
        one &quot;case&quot; label for each recognised node type - this includes the
        first 7 internal node types.
      </LI>
    </UL>

    <P>The root node will have internal type 0 and will cause any initial
    literal elements to be output. Text nodes will have internal node type 1
    and will simply be dumped to the output handler. Unrecognized elements
    will have internal node type 3 and will be given the default treatment
    (a new iterator is created for the node's children, and this iterator
    is passed with a recursive call to <CODE><FONT face="courier, monospaced">applyTemplates()</FONT></CODE>).
    Unrecognised attribute nodes (type 4) will be handled like text nodes.
    The <CODE><FONT face="courier, monospaced">switch()</FONT></CODE> statement in <CODE><FONT face="courier, monospaced">applyTemplates</FONT></CODE> will thereby
    look something like this:</P>

<DIV align="right"><TABLE border="0" cellpadding="0" cellspacing="4" width="464"><TR><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#0086b2" height="1" width="462"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="462"></TD><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#0086b2" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#ffffff" width="462"><FONT size="-1"><PRE>
        public void applyTemplates(DOM dom, NodeIterator,
                                   TransletOutputHandler handler) {

            // get nodes from iterator
            while ((node = iterator.next()) != END) {
                // get internal node type
                switch(DOM.getType(node)) {

                case 0: // root
                    outputPreable(handler);
                    break;
                case 1: // text
                    DOM.characters(node,handler);
                    break;
                case 3: // unrecognised element
                    NodeIterator newIterator = DOM.getChildren(node);
                    applyTemplates(DOM,newIterator,handler);
                    break;
                case 4: // unrecognised attribute
                    DOM.characters(node,handler);
                    break;
                case 7: // elements of type &lt;B&gt;
                    someCompiledCode();
                    break;
                case 8: // elements of type &lt;C&gt;
                    otherCompiledCode();
                    break;
                default:
                    break;
                }
            }
        }
</PRE></FONT></TD><TD bgcolor="#0086b2" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#0086b2" height="1" width="462"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="462"></TD><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR></TABLE></DIV>

    <P>Each recognised element will have its own piece of compiled code.</P>

    <P>Note that each &quot;case&quot; will not lead directly to a single template.
    There may be several templates that match node type 7
    (say <CODE><FONT face="courier, monospaced">&lt;B&gt;</FONT></CODE>). In the sample stylesheet in the previous chapter
    we have to templates that would match a node <CODE><FONT face="courier, monospaced">&lt;B&gt;</FONT></CODE>. We have
    one <CODE><FONT face="courier, monospaced">match=&quot;//B&quot;</FONT></CODE> (match just any <CODE><FONT face="courier, monospaced">&lt;B&gt;</FONT></CODE> element) and
    one <CODE><FONT face="courier, monospaced">match=&quot;A/B&quot;</FONT></CODE> (match a <CODE><FONT face="courier, monospaced">&lt;B&gt;</FONT></CODE> element that is a
    child of a <CODE><FONT face="courier, monospaced">&lt;A&gt;</FONT></CODE> element). In this case we would have to
    compile code that first gets the type of the current node's parent, and
    then compared this type with the type for <CODE><FONT face="courier, monospaced">&lt;A&gt;</FONT></CODE>. If there was
    no match we will have executed the first <CODE><FONT face="courier, monospaced">&lt;xsl:for-each&gt;</FONT></CODE>
    element, but if there was a match we will have executed the last one.
    Consequentally, the compiler will generate the following code:</P>

<DIV align="right"><TABLE border="0" cellpadding="0" cellspacing="4" width="464"><TR><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#0086b2" height="1" width="462"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="462"></TD><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#0086b2" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#ffffff" width="462"><FONT size="-1"><PRE>
        switch(DOM.getType(node)) {
          :
          :
        case 7: // elements of type &lt;B&gt;
            int parent = DOM.getParent(node);
            if (DOM.getType(parent) == 9) // type 9 = elements &lt;A&gt;
                someCompiledCode();
            else
                evenOtherCompiledCode();
            break;
          :
          :
        }
</PRE></FONT></TD><TD bgcolor="#0086b2" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#0086b2" height="1" width="462"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="462"></TD><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR></TABLE></DIV>

    <P>We could do the same for namespaces, that is, assign a numeric value
    to every namespace that is references in the stylesheet, and use an
    <CODE><FONT face="courier, monospaced">&quot;if&quot;</FONT></CODE> statement for each namespace that needs to be checked for
    each type. Lets say we had a stylesheet like this:</P>

<DIV align="right"><TABLE border="0" cellpadding="0" cellspacing="4" width="464"><TR><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#0086b2" height="1" width="462"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="462"></TD><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#0086b2" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#ffffff" width="462"><FONT size="-1"><PRE>
      &lt;?xml version=&quot;1.0&quot;?&gt;
      &lt;xsl:stylesheet version=&quot;1.0&quot; xmlns:xsl=&quot;blahblahblah&quot;&gt;

      &lt;xsl:template match=&quot;/&quot;
          xmlns:foo=&quot;http://foo.com/spec&quot;
          xmlns:bar=&quot;http://bar.net/ref&quot;&gt;
        &lt;xsl:for-each select=&quot;foo:A&quot;&gt;
          &lt;xsl:apply-templates select=&quot;.&quot; /&gt;
        &lt;/xsl:for-each&gt;
        &lt;xsl:for-each select=&quot;bar:A&quot;&gt;
          &lt;xsl:apply-templates select=&quot;.&quot; /&gt;
        &lt;/xsl:for-each&gt;
      &lt;/xsl:template&gt;

    &lt;/xsl:stylesheet&gt;
</PRE></FONT></TD><TD bgcolor="#0086b2" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#0086b2" height="1" width="462"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="462"></TD><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR></TABLE></DIV>

    <P>And a stylesheet like this:</P>

<DIV align="right"><TABLE border="0" cellpadding="0" cellspacing="4" width="464"><TR><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#0086b2" height="1" width="462"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="462"></TD><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#0086b2" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#ffffff" width="462"><FONT size="-1"><PRE>
      &lt;?xml version=&quot;1.0&quot;?&gt;

      &lt;DOC
          xmlns:foo=&quot;http://foo.com/spec&quot;
          xmlns:bar=&quot;http://bar.net/ref&quot;&gt;
        &lt;foo:A&gt;In foo namespace&lt;/foo:A&gt;
        &lt;bar:A&gt;In bar namespace&lt;/bar:A&gt;
      &lt;/DOC&gt;
</PRE></FONT></TD><TD bgcolor="#0086b2" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR><TR><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD><TD bgcolor="#0086b2" height="1" width="462"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="462"></TD><TD bgcolor="#0086b2" height="1" width="1"><IMG border="0" height="1" hspace="0" src="resources/void.gif" vspace="0" width="1"></TD></TR></TABLE></DIV>

    <P>We could still keep the same type for all <CODE><FONT face="courier, monospaced">&lt;A&gt;</FONT></CODE> elements
    regardless of what namespace they are in, and use the same <CODE><FONT face="courier, monospaced">&quot;if&quot;</FONT></CODE>
    structure within the <CODE><FONT face="courier, monospaced">switch()</FONT></CODE> statement above. The other option
    is to assign different types to <CODE><FONT face="courier, monospaced">&lt;foo:A&gt;</FONT></CODE> and
    <CODE><FONT face="courier, monospaced">&lt;bar:A&gt;</FONT></CODE> elements.</P>

  </FONT></TD></TR></TABLE><BR>
</TD></TR></TABLE></TD></TR></TABLE><BR><TABLE border="0" cellpadding="0" cellspacing="0" width="620"><TR><TD bgcolor="#0086b2"><IMG height="1" src="images/dot.gif" width="1"></TD></TR><TR><TD align="center"><FONT color="#0086b2" size="-1"><I>
              Copyright &copy; 2001 The Apache Software Foundation.
              All Rights Reserved.
            </I></FONT></TD></TR></TABLE></BODY></HTML>