#
#*******************************************************************************
#                                                                              *
# Component:                                                                   *
#                                                                              *
#    Makefile for KWVTOOL                                                      *
#                                                                              *
#*******************************************************************************
#

CFLAGS = -g
DEFINES = -D SUN_UNIX -D _NO_PROTO -D PDS_TOOLBOX -D LV_DDICT -D LV_KWVTOOL
ODLC_LABLIB_LIB = lib/odlc_lablib_kwvtool.a

KWVTOOL_DIR = legacy/kwvtool
SHARED_DIR = legacy/shared
LABLIB_DIR = lablib
ODLC_DIR = odlc

PDS_LABLIB_OBJ = $(LABLIB_DIR)/label.o \
	$(LABLIB_DIR)/labutil.o \
	$(LABLIB_DIR)/fiolib.o \
	$(LABLIB_DIR)/errorlib.o
PDS_ODLCLIB_OBJ = $(ODLC_DIR)/a_nodes.o \
	$(ODLC_DIR)/ao_nodes.o\
	$(ODLC_DIR)/p_nodes.o \
	$(ODLC_DIR)/v_nodes.o \
	$(ODLC_DIR)/lexan.o \
	$(ODLC_DIR)/parser.o \
	$(ODLC_DIR)/parsact.o \
	$(ODLC_DIR)/cvtvalue.o \
	$(ODLC_DIR)/fmtvalue.o \
	$(ODLC_DIR)/toolout.o \
	$(ODLC_DIR)/wrtlabel.o \
	$(ODLC_DIR)/rdlabel.o \
	$(ODLC_DIR)/prtlabel.o \
	$(ODLC_DIR)/comments.o \
	$(ODLC_DIR)/utillib.o \
	$(ODLC_DIR)/syslib.o
DDICT_OBJ = $(SHARED_DIR)/convert.o \
	$(SHARED_DIR)/ddaccess.o \
	$(SHARED_DIR)/search.o \
	$(SHARED_DIR)/verlabel.o \
	$(SHARED_DIR)/labtool.o

LABLIB_LIB_SOURCE = $(LABLIB_DIR)/label.c
ODLC_LIB_SOURCE = $(ODLC_DIR)/a_nodes.c
PDS_LIBRARIES = $(ODLC_LABLIB_LIB)
PDS_INCLUDES = -I$(ODLC_DIR) -I$(KWVTOOL_DIR) -I$(SHARED_DIR) -I$(LABLIB_DIR)

LINK_START = if [ -f $(KWVTOOL_DIR)/$(@F).c ]; then echo Making $@; cc $(CFLAGS) -o $@ $(KWVTOOL_DIR)/$(@F).o 
LINK_END = $(PDS_LIBRARIES); else exit 0; fi

#.SILENT:
.KEEP_STATE:

default: 
	if [ -f $(ODLC_LIB_SOURCE) ]; then make lib/odlc_kwvtool;  fi
	if [ -f $(LABLIB_LIB_SOURCE) ]; then make lib/lablib_kwvtool; fi
	if [ -f $(KWVTOOL_DIR)/kwvtool.c ]; then make bin/kwvtool; fi

lib/lablib_kwvtool: $(PDS_LABLIB_OBJ)
	if [ -f $(LABLIB_DIR)/label.c ]; then \
		ar rcv $(ODLC_LABLIB_LIB) $(PDS_LABLIB_OBJ); \
#		ranlib $(LABLIB_LIB);\
	fi

lib/odlc_kwvtool: $(PDS_ODLCLIB_OBJ)
	if [ -f $(ODLC_DIR)/parser.c ]; then \
		ar rcv $(ODLC_LABLIB_LIB) $(PDS_ODLCLIB_OBJ); \
#		ranlib $(ODLC_LIB); \
	fi

bin/kwvtool: $(PDS_LIBRARIES) $(KWVTOOL_DIR)/$$(@F).o $(DDICT_OBJ)
	$(LINK_START) $(DDICT_OBJ) $(LINK_END)


.c.o:
	if [ -f $*.c ]; then \
	     echo Making $@; \
	     cc $(CFLAGS) $(PDS_INCLUDES) $(DEFINES) -c $@ -o $*.o $*.c; \
	else \
		exit 0; \
	fi

clean:
	touch $(KWVTOOL_DIR)/*.o $(SHARED_DIR)/*.o $(ODLC_DIR)/*.o $(LABLIB_DIR)/*.o $(ODLC_LABLIB_LIB) bin/kwvtool
	rm $(KWVTOOL_DIR)/*.o $(SHARED_DIR)/*.o $(ODLC_DIR)/*.o $(LABLIB_DIR)/*.o $(ODLC_LABLIB_LIB) bin/kwvtool

